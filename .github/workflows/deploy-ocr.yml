name: Deploy OCR Service to DigitalOcean

on:
  push:
    branches: [main, staging]
    paths:
      - 'services/ocr-service/**'
      - '.github/workflows/deploy-ocr.yml'
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com/insightpulse
  IMAGE_NAME: ocr-service
  DROPLET_IP: 162.159.140.98  # ocr.insightpulseai.net

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DO Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./services/ocr-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: https://ocr.insightpulseai.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            set -e
            
            # Pull latest image
            docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} registry.digitalocean.com
            docker pull ${{ needs.build.outputs.image_tag }}

            # Stop old container
            docker stop ocr || true
            docker rm ocr || true

            # Start new container
            docker run -d \
              --name ocr \
              --restart unless-stopped \
              -p 8080:8080 \
              -v /opt/paddleocr/models:/root/.paddleocr \
              -e LOG_LEVEL=INFO \
              ${{ needs.build.outputs.image_tag }}

            # Health check
            sleep 10
            curl -f http://localhost:8080/health || exit 1

      - name: Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            # Test health endpoint
            curl -f https://ocr.insightpulseai.net/health
            
            # Test OCR endpoint with sample image
            # (Assumes you have a test image at /opt/test/receipt.jpg)
            if [ -f /opt/test/receipt.jpg ]; then
              curl -X POST https://ocr.insightpulseai.net/ocr \
                -F "file=@/opt/test/receipt.jpg" \
                | jq -e '.status == "success"'
            fi

      - name: Log to Supabase
        if: always()
        run: |
          curl -X POST https://spdtwktxdalcfigzeqrz.supabase.co/rest/v1/deployment_logs \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "service": "ocr-service",
              "environment": "${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}",
              "status": "${{ job.status }}",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "deployed_by": "${{ github.actor }}",
              "deployed_at": "${{ github.event.head_commit.timestamp }}"
            }'

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            OCR Service deployment to ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
            Result: ${{ job.status }}
            Commit: ${{ github.event.head_commit.message }}
            URL: https://ocr.insightpulseai.net
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
