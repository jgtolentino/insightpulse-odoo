name: Automation Health Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      layer:
        description: 'Validation layer to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - static
          - automated
          - integration
          - production
      fast_mode:
        description: 'Run in fast mode (skip intensive checks)'
        required: false
        default: false
        type: boolean

jobs:
  automation-health:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 mypy bandit pip-audit pytest yamllint
          pip install -r requirements.txt || echo "No requirements.txt found"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client curl

      - name: Set environment variables
        run: |
          echo "LAYER=${{ github.event.inputs.layer || 'all' }}" >> $GITHUB_ENV
          echo "FAST_MODE=${{ github.event.inputs.fast_mode || 'false' }}" >> $GITHUB_ENV

      - name: Run automation health check
        id: health_check
        run: |
          chmod +x ci/automation-health.sh

          if [ "$FAST_MODE" = "true" ]; then
            ./ci/automation-health.sh --layer "$LAYER" --fast --json > health-report.json || true
          else
            ./ci/automation-health.sh --layer "$LAYER" --json > health-report.json || true
          fi

          # Extract results
          TOTAL=$(jq -r '.total_checks' health-report.json)
          PASSED=$(jq -r '.passed' health-report.json)
          FAILED=$(jq -r '.failed' health-report.json)
          WARNINGS=$(jq -r '.warnings' health-report.json)
          PASS_RATE=$(jq -r '.pass_rate' health-report.json)

          echo "total_checks=${TOTAL}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "warnings=${WARNINGS}" >> $GITHUB_OUTPUT
          echo "pass_rate=${PASS_RATE}" >> $GITHUB_OUTPUT

          # Determine status
          if [ "$FAILED" -gt 0 ]; then
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "status_emoji=üî¥" >> $GITHUB_OUTPUT
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "status_emoji=üü°" >> $GITHUB_OUTPUT
          else
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "status_emoji=üü¢" >> $GITHUB_OUTPUT
          fi

      - name: Upload health report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: automation-health-report
          path: health-report.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('health-report.json', 'utf8'));

            const status = '${{ steps.health_check.outputs.status }}';
            const emoji = '${{ steps.health_check.outputs.status_emoji }}';
            const layer = '${{ env.LAYER }}';

            const body = `## ${emoji} Automation Health Check Results

            **Layer:** \`${layer}\`
            **Status:** **${status.toUpperCase()}**
            **Pass Rate:** ${report.pass_rate}%

            ### Summary
            - ‚úÖ Passed: ${report.passed}
            - ‚ùå Failed: ${report.failed}
            - ‚ö†Ô∏è Warnings: ${report.warnings}
            - **Total Checks:** ${report.total_checks}

            ### Details

            <details>
            <summary>View all check results</summary>

            ${report.results.map(r => {
              const icon = r.status === 'PASS' ? '‚úÖ' : r.status === 'FAIL' ? '‚ùå' : r.status === 'WARN' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
              return `- ${icon} ${r.message}`;
            }).join('\n')}

            </details>

            **Timestamp:** ${report.timestamp}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Create check run
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.health_check.outputs.status }}';
            const failed = parseInt('${{ steps.health_check.outputs.failed }}');

            const conclusion = failed > 0 ? 'failure' : status === 'warning' ? 'neutral' : 'success';

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Automation Health Check',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `${{ steps.health_check.outputs.status_emoji }} Automation Health: ${status.toUpperCase()}`,
                summary: `Pass Rate: ${{ steps.health_check.outputs.pass_rate }}%`,
                text: `Total: ${{ steps.health_check.outputs.total_checks }} | Passed: ${{ steps.health_check.outputs.passed }} | Failed: ${{ steps.health_check.outputs.failed }} | Warnings: ${{ steps.health_check.outputs.warnings }}`
              }
            });

      - name: Update automation status badge
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          STATUS="${{ steps.health_check.outputs.status }}"
          PASS_RATE="${{ steps.health_check.outputs.pass_rate }}"

          # Create badge data
          mkdir -p .github/badges

          case $STATUS in
            healthy)
              COLOR="brightgreen"
              ;;
            warning)
              COLOR="yellow"
              ;;
            unhealthy)
              COLOR="red"
              ;;
          esac

          echo "{\"schemaVersion\": 1, \"label\": \"automation health\", \"message\": \"${PASS_RATE}%\", \"color\": \"${COLOR}\"}" > .github/badges/automation-health.json

      - name: Commit badge update
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -f .github/badges/automation-health.json ]; then
            git add .github/badges/automation-health.json
            git diff --staged --quiet || git commit -m "chore: update automation health badge [skip ci]"
            git push || echo "No changes to push"
          fi

      - name: Send Slack notification
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üî¥ Automation Health Check Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Automation Health Check Failed*\n\n*Repository:* ${{ github.repository }}\n*Layer:* `${{ env.LAYER }}`\n*Pass Rate:* ${{ steps.health_check.outputs.pass_rate }}%\n*Failed Checks:* ${{ steps.health_check.outputs.failed }}\n*Warnings:* ${{ steps.health_check.outputs.warnings }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Fail if unhealthy
        if: steps.health_check.outputs.status == 'unhealthy'
        run: |
          echo "‚ùå Automation health check failed with ${{ steps.health_check.outputs.failed }} failures"
          exit 1

  instance-health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: automation-health
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        environment: [local, staging, production]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client curl jq

      - name: Load instance configuration
        run: |
          # Extract environment-specific configuration from instance-matrix.yaml
          # This would require yq or similar YAML parser
          echo "Instance health check for ${{ matrix.environment }} environment"

      - name: Run instance health check
        id: instance_check
        env:
          ODOO_DB_URL_LOCAL: ${{ secrets.ODOO_DB_URL_LOCAL }}
          SUPABASE_DB_URL_LOCAL: ${{ secrets.SUPABASE_DB_URL_LOCAL }}
          SUPERSET_META_DB_URL_LOCAL: ${{ secrets.SUPERSET_META_DB_URL_LOCAL }}
          ODOO_DB_URL_STAGING: ${{ secrets.ODOO_DB_URL_STAGING }}
          SUPABASE_DB_URL_STAGING: ${{ secrets.SUPABASE_DB_URL_STAGING }}
          SUPERSET_META_DB_URL_STAGING: ${{ secrets.SUPERSET_META_DB_URL_STAGING }}
          ODOO_DB_URL_PRODUCTION: ${{ secrets.ODOO_DB_URL_PRODUCTION }}
          SUPABASE_DB_URL_PRODUCTION: ${{ secrets.SUPABASE_DB_URL_PRODUCTION }}
          SUPERSET_META_DB_URL_PRODUCTION: ${{ secrets.SUPERSET_META_DB_URL_PRODUCTION }}
        run: |
          chmod +x scripts/health/check-instance-health.sh

          if ./scripts/health/check-instance-health.sh ${{ matrix.environment }}; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "status_emoji=‚ùå" >> $GITHUB_OUTPUT
          fi

      - name: Report instance health
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.instance_check.outputs.status }}';
            const emoji = '${{ steps.instance_check.outputs.status_emoji }}';
            const environment = '${{ matrix.environment }}';

            console.log(`${emoji} Instance health for ${environment}: ${status.toUpperCase()}`);

  update-automation-status:
    runs-on: ubuntu-latest
    needs: [automation-health, instance-health]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update AUTOMATION_STATUS.md
        run: |
          # Update last run timestamp in AUTOMATION_STATUS.md
          TIMESTAMP=$(date -u +"%Y-%m-%d")

          if [ -f docs/AUTOMATION_STATUS.md ]; then
            sed -i "s/Last Updated: .*/Last Updated: ${TIMESTAMP}/" docs/AUTOMATION_STATUS.md
            sed -i "s/Last Run | .*/Last Run | ${TIMESTAMP} |/" docs/AUTOMATION_STATUS.md
          fi

      - name: Commit status update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/AUTOMATION_STATUS.md
          git diff --staged --quiet || git commit -m "chore: update automation status timestamp [skip ci]"
          git push || echo "No changes to push"
