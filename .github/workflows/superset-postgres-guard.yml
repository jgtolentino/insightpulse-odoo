name: Superset PostgreSQL Guard

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'infra/superset/**'
      - '.github/workflows/superset-postgres-guard.yml'

env:
  DO_APP_ID_SUPERSET: ${{ secrets.DO_APP_ID_SUPERSET }}
  DOCTL_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

jobs:
  postgres-guard:
    runs-on: ubuntu-latest
    name: Ensure Superset uses PostgreSQL only

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Verify Superset app exists
        run: |
          doctl apps get $DO_APP_ID_SUPERSET --format ID,DefaultIngress
          echo "âœ… Superset app found"

      - name: Guard - Fail if SQLite detected
        run: |
          echo "ğŸ” Checking database configuration in app spec..."

          # Get database URI from app spec
          DB_URI=$(doctl apps get $DO_APP_ID_SUPERSET -o json | \
            jq -r '.[0].spec.services[].envs[] | select(.key == "SQLALCHEMY_DATABASE_URI") | .value' 2>/dev/null || echo "")

          echo "Database URI: ${DB_URI:0:30}..." # Show prefix only for security

          if [[ -z "$DB_URI" ]]; then
            echo "âŒ ERROR: SQLALCHEMY_DATABASE_URI not found in app spec"
            echo "Fix: Add SQLALCHEMY_DATABASE_URI to Superset service environment variables"
            exit 1
          fi

          if [[ "$DB_URI" =~ ^sqlite ]]; then
            echo "âŒ ERROR: Superset is configured with SQLite (deprecated)"
            echo "Current: $DB_URI"
            echo "Expected: postgresql+psycopg2://..."
            echo "Fix: Update SQLALCHEMY_DATABASE_URI in app spec to PostgreSQL connection string"
            exit 1
          fi

          if [[ "$DB_URI" =~ ^postgresql ]]; then
            echo "âœ… PostgreSQL configuration confirmed"
          else
            echo "âš ï¸ WARNING: Unexpected database URI format"
            echo "Expected: postgresql+psycopg2://... but got: ${DB_URI:0:30}..."
          fi

      - name: Note - Sample dashboard loading
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "â„¹ï¸  Manual workflow dispatch detected"
          echo "Note: To load sample dashboards, use Superset UI or console"
          echo "Console: doctl apps console $DO_APP_ID_SUPERSET superset"
          echo "Command: superset load_examples && superset init"

      - name: Health check
        run: |
          echo "ğŸ¥ Checking Superset health..."

          # Get app URL
          APP_URL=$(doctl apps get $DO_APP_ID_SUPERSET --format DefaultIngress --no-header)

          # Test connectivity
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$APP_URL/health || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Superset is healthy (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Superset health check returned HTTP $HTTP_CODE"
          fi

      - name: Report status
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Superset PostgreSQL Guard - Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "App ID: $DO_APP_ID_SUPERSET"
          echo "Workflow: ${{ github.workflow }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Status: ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
