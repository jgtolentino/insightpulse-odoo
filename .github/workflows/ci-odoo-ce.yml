name: odoo-ce-ci

on:
  push:
  pull_request:

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Guardrail – Block Enterprise modules
        run: |
          set -e
          echo "Scanning for Enterprise module dependencies in code..."
          # Look for actual Enterprise dependencies, not just the word "enterprise" in docs
          # Check for: import statements, module dependencies in __manifest__.py
          matches=$(grep -Rn "from odoo\.addons\..*_enterprise" addons oca 2>/dev/null || true)
          matches="$matches$(grep -Rn "import odoo\.addons\..*_enterprise" addons oca 2>/dev/null || true)"
          matches="$matches$(grep -A5 '"depends"' addons/*/__manifest__.py oca/*/__manifest__.py 2>/dev/null | grep -i "enterprise" || true)"
          if [ -n "$matches" ]; then
            echo "::error::Found Enterprise module dependencies in addons/ or oca/ – CE-only policy violated."
            echo "$matches"
            exit 1
          fi
          echo "No Enterprise module dependencies found."

      - name: Guardrail – Block upstream odoo.com links
        run: |
          set -e
          echo "Scanning for odoo.com links in user-facing code/docs..."
          # Restrict scan to relevant paths so we don't flag CI scripts themselves
          matches=$(grep -Rni "odoo\.com" addons oca deploy specs docs README* 2>/dev/null || true)
          if [ -n "$matches" ]; then
            echo "::error::Found references to 'odoo.com' in user-facing code or docs – replace with InsightPulse/OCA links."
            echo "$matches"
            exit 1
          fi
          echo "No odoo.com links found in user-facing code/docs."

      - name: Python lint (optional baseline)
        run: |
          python -m compileall addons || true
