name: Self-Healing CI/CD Pipeline

# Enterprise-grade self-healing pipeline with automatic failure recovery
# Implements retry logic, auto-rollback, diagnosis, and intelligent notifications

on:
  workflow_call:
    inputs:
      job_name:
        description: 'Name of the job to run with self-healing'
        required: true
        type: string
      max_retries:
        description: 'Maximum retry attempts'
        required: false
        type: number
        default: 3
      enable_rollback:
        description: 'Enable automatic rollback on failure'
        required: false
        type: boolean
        default: true
    outputs:
      status:
        description: 'Final status of the self-healing job'
        value: ${{ jobs.self-healing-job.outputs.status }}
      diagnostic_report:
        description: 'Diagnostic report for failures'
        value: ${{ jobs.self-healing-job.outputs.diagnostic_report }}

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

env:
  RETRY_BACKOFF_BASE: 2  # Exponential backoff base (seconds)
  MAX_RETRY_DELAY: 300   # Max delay between retries (5 minutes)

jobs:
  # ============================================================================
  # SELF-HEALING JOB WITH RETRY LOGIC
  # Automatically retries failed jobs with exponential backoff
  # ============================================================================
  self-healing-job:
    name: Self-Healing Job Runner
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.final-status.outputs.status }}
      diagnostic_report: ${{ steps.diagnose.outputs.report }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up environment
        run: |
          echo "RETRY_COUNT=0" >> $GITHUB_ENV
          echo "LAST_ERROR=''" >> $GITHUB_ENV
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Execute with self-healing
        id: execute
        continue-on-error: true
        run: |
          # This is a template - actual job execution would go here
          # For now, demonstrate the self-healing mechanism
          
          RETRY_COUNT=0
          MAX_RETRIES=3
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
            
            # Calculate exponential backoff delay
            if [ $RETRY_COUNT -gt 0 ]; then
              DELAY=$((2 ** RETRY_COUNT))
              if [ $DELAY -gt $MAX_RETRY_DELAY ]; then
                DELAY=$MAX_RETRY_DELAY
              fi
              echo "Waiting ${DELAY}s before retry..."
              sleep $DELAY
            fi
            
            # Attempt job execution (placeholder)
            if .github/scripts/ci/execute-job.sh "${{ inputs.job_name || 'test' }}"; then
              SUCCESS=true
              echo "âœ… Job succeeded on attempt $((RETRY_COUNT + 1))"
            else
              echo "âŒ Job failed on attempt $((RETRY_COUNT + 1))"
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done
          
          if [ "$SUCCESS" = "true" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Diagnose failure
        id: diagnose
        if: failure()
        run: |
          echo "Running diagnostic analysis..."
          
          # Create diagnostic report
          cat > diagnostic-report.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "job": "${{ inputs.job_name || 'test' }}",
            "status": "failed",
            "retry_count": ${{ env.RETRY_COUNT }},
            "duration": $(($(date +%s) - ${{ env.START_TIME }})),
            "suggested_fixes": [
              "Check dependency versions for conflicts",
              "Verify environment variables are set correctly",
              "Review recent code changes for breaking changes",
              "Check external service availability"
            ],
            "root_cause_analysis": "Automated diagnosis in progress",
            "next_steps": [
              "Review logs in the Actions tab",
              "Check if this is a flaky test",
              "Consider adding retry logic at the test level"
            ]
          }
          EOF
          
          # Output report
          REPORT=$(cat diagnostic-report.json | jq -c .)
          echo "report=$REPORT" >> $GITHUB_OUTPUT
          
          # Upload artifact
          echo "Diagnostic report created"

      - name: Auto-resolve dependency conflicts
        if: failure()
        continue-on-error: true
        run: |
          echo "Attempting automatic dependency resolution..."
          
          # Check for common dependency issues
          if [ -f requirements.txt ]; then
            echo "Checking Python dependencies..."
            pip check || {
              echo "Found dependency conflicts, attempting resolution..."
              pip install --upgrade pip
              pip install -r requirements.txt --upgrade
            }
          fi
          
          if [ -f package.json ]; then
            echo "Checking npm dependencies..."
            npm ls || {
              echo "Found npm conflicts, attempting resolution..."
              rm -rf node_modules package-lock.json
              npm install
            }
          fi

      - name: Trigger rollback
        if: failure() && inputs.enable_rollback == true
        uses: ./.github/workflows/rollback.yml
        with:
          reason: "Self-healing pipeline detected failure after ${{ env.RETRY_COUNT }} retries"
          
      - name: Create issue for unrecoverable failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const diagnostic = ${{ steps.diagnose.outputs.report || '{}' }};
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Self-Healing Pipeline Failed: ${{ inputs.job_name || 'Unknown Job' }}`,
              body: `
              ## Unrecoverable CI/CD Failure
              
              The self-healing pipeline was unable to recover from this failure after ${{ env.RETRY_COUNT }} retry attempts.
              
              ### Details
              - **Job**: ${{ inputs.job_name || 'test' }}
              - **Workflow**: ${{ github.workflow }}
              - **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              - **Branch**: ${{ github.ref }}
              - **Commit**: ${{ github.sha }}
              
              ### Diagnostic Report
              \`\`\`json
              ${JSON.stringify(diagnostic, null, 2)}
              \`\`\`
              
              ### Suggested Actions
              ${diagnostic.suggested_fixes?.map(fix => `- ${fix}`).join('\n') || 'No automated suggestions available'}
              
              ### Next Steps
              ${diagnostic.next_steps?.map(step => `1. ${step}`).join('\n') || 'Manual investigation required'}
              
              ---
              *This issue was automatically created by the self-healing pipeline*
              `,
              labels: ['ci-failure', 'auto-created', 'high-priority']
            });
            
            console.log(`Created issue #${issue.data.number}`);

      - name: Notify on unrecoverable failure
        if: failure()
        run: |
          echo "::error::Self-healing pipeline exhausted all recovery options"
          echo "::error::An issue has been created for manual intervention"
          echo "See diagnostic report for details"

      - name: Set final status
        id: final-status
        if: always()
        run: |
          if [ "${{ steps.execute.outcome }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Job completed successfully"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Job failed after all recovery attempts"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: self-healing-diagnostics
          path: |
            diagnostic-report.json
            logs/
          retention-days: 30

  # ============================================================================
  # HEALTH CHECK - Verify system state after self-healing
  # ============================================================================
  health-check:
    name: Post-Healing Health Check
    runs-on: ubuntu-latest
    needs: self-healing-job
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run health checks
        run: |
          echo "Running post-healing health checks..."
          
          # Check if self-healing scripts exist
          if [ -f scripts/ci/health-check.sh ]; then
            bash scripts/ci/health-check.sh
          else
            echo "Health check script not found, creating basic check..."
            
            # Basic health checks
            echo "Checking Git repository..."
            git status
            
            echo "Checking disk space..."
            df -h
            
            echo "Checking memory..."
            free -h
            
            echo "All basic checks passed"
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## Self-Healing Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Job Status | ${{ needs.self-healing-job.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Retry Count | ${{ env.RETRY_COUNT || 0 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | $(($(date +%s) - ${{ env.START_TIME || 0 }}))s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.self-healing-job.outputs.status }}" = "success" ]; then
            echo "âœ… **Pipeline recovered successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Manual intervention required**" >> $GITHUB_STEP_SUMMARY
          fi
