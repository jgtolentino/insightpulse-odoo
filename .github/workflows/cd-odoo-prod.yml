name: CD - Odoo Production

on:
  push:
    branches:
      - main
    paths:
      - 'odoo/**'
      - 'scripts/deploy/**'
      - 'docker-compose*.yml'
      - 'portal/**'
      - 'infra/nginx/**'

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy Odoo to Production
    environment: production

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 165.227.10.178 >> ~/.ssh/known_hosts

      - name: Deploy to production droplet
        run: |
          ssh -o StrictHostKeyChecking=no root@165.227.10.178 << 'EOF'
            set -euo pipefail

            echo "ðŸš€ Starting production deployment..."

            # Navigate to repository
            cd /opt/odoo || {
              echo "âŒ ERROR: /opt/odoo directory not found"
              exit 1
            }

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code from Git..."
            git pull || {
              echo "âŒ ERROR: Git pull failed"
              exit 1
            }

            # Pull latest images
            echo "ðŸ“¦ Pulling latest Docker images..."
            docker compose pull || {
              echo "âŒ ERROR: docker compose pull failed"
              exit 1
            }

            # Restart services
            echo "ðŸ”„ Restarting services with latest images..."
            docker compose up -d --remove-orphans || {
              echo "âŒ ERROR: docker compose up failed"
              exit 1
            }

            echo "â³ Waiting 15 seconds for services to stabilize..."
            sleep 15

            echo "âœ… Docker deployment complete"
            echo ""
            echo "ðŸ“Š Running containers:"
            docker compose ps

            # Deploy unified portal (SSO landing page)
            echo ""
            echo "ðŸŒ Deploying unified portal..."

            # Set portal file permissions
            chmod 755 portal/
            chmod 644 portal/index.html portal/login.html
            chmod -R 755 portal/static/

            # Update nginx configuration
            echo "ðŸ“ Updating nginx configuration..."
            sudo cp infra/nginx/insightpulseai.net.conf /etc/nginx/sites-available/insightpulseai.net

            # Test nginx configuration
            sudo nginx -t || {
              echo "âŒ ERROR: nginx configuration test failed"
              exit 1
            }

            # Reload nginx
            echo "ðŸ”„ Reloading nginx..."
            sudo systemctl reload nginx

            echo "âœ… Portal deployment complete"
          EOF

      - name: Smoke test - ERP service
        run: |
          echo "ðŸ” Testing ERP service at https://erp.insightpulseai.net/web/login"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://erp.insightpulseai.net/web/login)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ERP smoke test passed - HTTP $HTTP_CODE"
          else
            echo "âŒ ERP smoke test failed - HTTP $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Smoke test - Unified portal
        run: |
          echo "ðŸ” Testing unified portal at https://insightpulseai.net"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://insightpulseai.net)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Portal smoke test passed - HTTP $HTTP_CODE"
          else
            echo "âŒ Portal smoke test failed - HTTP $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Smoke test - Portal authentication
        run: |
          echo "ðŸ” Testing portal authentication endpoint"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST https://insightpulseai.net/web/database/list \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"call","params":{},"id":1}')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Authentication endpoint test passed - HTTP $HTTP_CODE"
          else
            echo "âŒ Authentication endpoint test failed - HTTP $HTTP_CODE (expected 200)"
            exit 1
          fi

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
