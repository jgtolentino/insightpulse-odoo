name: Claude Config — Validate & Sync
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: claude-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  CLAUDE_MD: ${{ vars.CLAUDE_MD || 'claude.md' }}
  SKILLS_DIR: ${{ vars.SKILLS_DIR || 'docs/claude-code-skills' }}
  MCP_CFG: ${{ vars.MCP_CFG || 'mcp/vscode-mcp-config.json' }}
  CLAUDE_SYNC_WRITE: ${{ vars.CLAUDE_SYNC_WRITE || 'false' }}
  PYTHON_VERSION: '3.11'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: ${{ env.PYTHON_VERSION }} }

      - name: Install deps (validator/script deps only)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install markdown-it-py rich click pyyaml

      - name: Phase 2.2 — validate config
        run: |
          python scripts/validate-claude-config.py

      - name: Drift check — Section 19
        id: drift
        run: |
          chmod +x scripts/skillsmith_sync.py
          ./scripts/skillsmith_sync.py --check || echo "DRIFT=1" >> $GITHUB_OUTPUT

      - name: Annotate PR if drift
        if: ${{ steps.drift.outputs.DRIFT == '1' && github.event_name == 'pull_request' }}
        run: |
          python scripts/ci/post-status-comment.py --context 'Section 19 drift detected. Run `make claude:sync-write` locally or enable auto-PR.' || true

      - name: Auto-PR if drift and write enabled
        if: ${{ steps.drift.outputs.DRIFT == '1' && env.CLAUDE_SYNC_WRITE == 'true' && github.event_name != 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash scripts/ci/open-pr-on-drift.sh \
            --branch "bot/section19-sync" \
            --title "chore(claude): sync Section 19 from ${SKILLS_DIR}" \
            --body "Automated sync of Section 19 (skills inventory)."
