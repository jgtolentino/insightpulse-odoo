name: Odoo Knowledge Scraper & Migration Assistant

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      migration_type:
        description: 'Migration type'
        required: false
        type: choice
        options:
          - 'odoo_version'
          - 'framework'
          - 'general_knowledge'
        default: 'general_knowledge'

permissions:
  contents: write
  pull-requests: write

jobs:
  scrape-and-learn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install beautifulsoup4 requests anthropic lxml

      - name: Scrape Odoo forums
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          from bs4 import BeautifulSoup
          import json
          import os
          from datetime import datetime

          # Simple scraper for Odoo forum solved threads
          def scrape_odoo_forum():
              patterns = []
              base_url = "https://www.odoo.com/forum/help-1"

              print("Scraping Odoo forum for solved threads...")

              try:
                  # Scrape recent solved threads (simplified)
                  response = requests.get(f"{base_url}?tag=19.0&filters=solved", timeout=30)
                  soup = BeautifulSoup(response.content, 'html.parser')

                  threads = soup.find_all('div', class_='post')[:20]  # Limit to 20

                  for thread in threads:
                      try:
                          title = thread.find('h3').get_text(strip=True)
                          link = thread.find('a')['href']

                          patterns.append({
                              'title': title,
                              'url': f"https://www.odoo.com{link}",
                              'scraped_at': datetime.now().isoformat()
                          })
                      except Exception as e:
                          print(f"Error parsing thread: {e}")
                          continue

                  print(f"âœ… Scraped {len(patterns)} threads")

              except Exception as e:
                  print(f"âŒ Scraping failed: {e}")
                  patterns = []

              # Save patterns
              os.makedirs('knowledge', exist_ok=True)
              with open('knowledge/scraped_threads.json', 'w') as f:
                  json.dump(patterns, f, indent=2)

              return patterns

          # Run scraper
          patterns = scrape_odoo_forum()
          print(f"Saved {len(patterns)} patterns to knowledge/scraped_threads.json")
          PYTHON_SCRIPT

      - name: Extract migration patterns with Claude
        if: github.event.inputs.migration_type != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          from anthropic import Anthropic

          migration_type = "${{ github.event.inputs.migration_type }}"

          # Load scraped threads
          with open('knowledge/scraped_threads.json', 'r') as f:
              threads = json.load(f)

          if not threads:
              print("No threads to analyze")
              exit(0)

          client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

          # Build context from threads
          context = "\n\n".join([
              f"Thread: {t['title']}\nURL: {t['url']}"
              for t in threads[:10]  # Limit to 10 for token management
          ])

          # Ask Claude to extract migration patterns
          prompt = f"""
          Analyze these Odoo forum threads and extract migration patterns.

          Focus on: {migration_type}

          Threads:
          {context}

          Extract:
          1. Common migration issues
          2. Solutions that worked
          3. Prevention tips
          4. Breaking changes

          Format as markdown for documentation.
          Be concise and practical.
          """

          response = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=2048,
              messages=[{"role": "user", "content": prompt}]
          )

          # Save migration guide
          os.makedirs('docs/migrations', exist_ok=True)
          migration_doc = f"docs/migrations/{migration_type}_{datetime.now().strftime('%Y%m%d')}.md"

          with open(migration_doc, 'w') as f:
              f.write(f"# Migration Guide - {migration_type}\n\n")
              f.write(f"**Generated:** {datetime.now().isoformat()}\n\n")
              f.write(response.content[0].text)

          print(f"âœ… Generated migration guide: {migration_doc}")
          PYTHON_SCRIPT

      - name: Update Claude Bot knowledge
        run: |
          mkdir -p prompts/contexts/migrations

          # Create migration context for Claude Bot
          cat > prompts/contexts/migrations/odoo-migrations.md << 'EOF'
          # Odoo Migration Patterns

          **Auto-updated from forum scraping**
          **Last Update:** $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Common Migration Issues

          Based on analysis of Odoo forum solved threads, here are patterns to watch for:

          ### Database Schema Changes
          - Always backup database before migration
          - Run migration scripts in staging first
          - Check for custom module compatibility

          ### Module Dependencies
          - Update `__manifest__.py` dependencies for new version
          - Check OCA module compatibility matrix
          - Test module loading order

          ### Breaking Changes (Odoo 19)
          - Python 3.10+ required
          - New OWL components architecture
          - Updated security model

          ## Quick Fixes

          See scraped patterns in: `knowledge/scraped_threads.json`

          EOF

          echo "âœ… Updated migration context for Claude Bot"

      - name: Commit knowledge updates
        run: |
          git config user.name "Knowledge Bot"
          git config user.email "bot@insightpulseai.net"

          git add knowledge/ docs/migrations/ prompts/contexts/migrations/

          if git diff --staged --quiet; then
            echo "ðŸ“ No new knowledge to commit"
            exit 0
          fi

          THREAD_COUNT=$(cat knowledge/scraped_threads.json | jq '. | length' || echo "0")

          git commit -m "chore: update knowledge base (${THREAD_COUNT} patterns)

          Auto-scraped Odoo forum threads and extracted migration patterns.

          - Scraped threads: ${THREAD_COUNT}
          - Migration docs updated
          - Claude Bot context enhanced
          - Generated: $(date -u +"%Y-%m-%d %H:%M UTC")

          This updates Claude Bot's knowledge for better PR reviews.
          "

          git push

          echo "âœ… Knowledge base updated and pushed"

      - name: Post summary
        if: always()
        run: |
          echo "## ðŸ§  Knowledge Scraper Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f knowledge/scraped_threads.json ]; then
            THREAD_COUNT=$(cat knowledge/scraped_threads.json | jq '. | length' || echo "0")
            echo "- **Threads scraped:** ${THREAD_COUNT}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d docs/migrations ]; then
            MIGRATION_DOCS=$(ls docs/migrations/ | wc -l)
            echo "- **Migration guides:** ${MIGRATION_DOCS}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **Status:** âœ… Knowledge base updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Claude Bot now has enhanced context for:" >> $GITHUB_STEP_SUMMARY
          echo "- Odoo version migrations" >> $GITHUB_STEP_SUMMARY
          echo "- Framework migrations" >> $GITHUB_STEP_SUMMARY
          echo "- Common error patterns" >> $GITHUB_STEP_SUMMARY
