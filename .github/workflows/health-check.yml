name: Finance Stack Health Check

on:
  schedule:
    # Daily at 2 AM UTC (10 AM PHT)
    - cron: '0 2 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging
      fix_mode:
        description: 'Enable auto-fix mode'
        required: false
        default: false
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Run verify_finance_stack.sh
        id: verify_stack
        continue-on-error: true
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          ENV="${{ inputs.environment || 'prod' }}"
          FIX_FLAG="${{ inputs.fix_mode == true && '--fix' || '' }}"

          ssh root@erp.insightpulseai.net \
            "cd /opt/odoo-ce/notion-n8n-monthly-close && \
             SUPABASE_SERVICE_ROLE_KEY='$SUPABASE_SERVICE_ROLE_KEY' \
             N8N_API_KEY='$N8N_API_KEY' \
             ./scripts/verify_finance_stack.sh --env $ENV $FIX_FLAG" \
            > health-report-stack.txt 2>&1

          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Run check_project_tasks.py
        id: check_tasks
        continue-on-error: true
        env:
          ODOO_PASSWORD: ${{ secrets.ODOO_PASSWORD }}
        run: |
          ssh root@erp.insightpulseai.net \
            "cd /opt/odoo-ce && \
             ODOO_URL='https://erp.insightpulseai.net' \
             ODOO_DB='odoo' \
             ODOO_LOGIN='jgtolentino_rn@yahoo.com' \
             ODOO_PASSWORD='$ODOO_PASSWORD' \
             python3 scripts/check_project_tasks.py" \
            > health-report-tasks.txt 2>&1

          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Combine reports
        id: combine
        run: |
          echo "# Finance Stack Health Check Report" > health-report-combined.md
          echo "" >> health-report-combined.md
          echo "**Environment:** ${{ inputs.environment || 'prod' }}" >> health-report-combined.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> health-report-combined.md
          echo "**Workflow Run:** ${{ github.run_id }}" >> health-report-combined.md
          echo "" >> health-report-combined.md

          echo "## Stack Verification" >> health-report-combined.md
          echo '```' >> health-report-combined.md
          cat health-report-stack.txt >> health-report-combined.md
          echo '```' >> health-report-combined.md
          echo "" >> health-report-combined.md

          echo "## Task Validation" >> health-report-combined.md
          echo '```' >> health-report-combined.md
          cat health-report-tasks.txt >> health-report-combined.md
          echo '```' >> health-report-combined.md

          # Determine overall status
          if [[ "${{ steps.verify_stack.outputs.exit_code }}" == "0" ]] && \
             [[ "${{ steps.check_tasks.outputs.exit_code }}" == "0" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "**Overall Status:** ✅ PASSED" >> health-report-combined.md
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "**Overall Status:** ❌ FAILED" >> health-report-combined.md
          fi

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ inputs.environment || 'prod' }}-${{ github.run_id }}
          path: |
            health-report-*.txt
            health-report-combined.md
          retention-days: 30

      - name: Trigger n8n alert on failure
        if: steps.combine.outputs.status == 'failure'
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          curl -X POST "$N8N_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "source": "github_actions",
              "status": "FAILED",
              "environment": "${{ inputs.environment || 'prod' }}",
              "workflow_run": "${{ github.run_id }}",
              "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
            }'

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.combine.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('health-report-combined.md', 'utf8');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ⚠️ Finance Stack Health Check Failed\n\n${report}\n\nPlease review the health check failures before merging.`
            });

      - name: Fail workflow if checks failed
        if: steps.combine.outputs.status == 'failure'
        run: exit 1
