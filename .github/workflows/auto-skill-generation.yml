name: Auto Skill Generation

on:
  push:
    branches: [main, develop]
    paths:
      - 'custom/**/*.py'
      - 'addons/**/*.py'
      - 'packages/**/*.py'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Minimum lines of code threshold for skill generation'
        required: false
        default: '500'
      auto_generate:
        description: 'Auto-generate skills (true) or just suggest (false)'
        required: false
        default: 'false'

jobs:
  analyze-and-generate-skills:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml  # For SKILL.md frontmatter

      - name: Analyze codebase and suggest skills
        id: suggest
        run: |
          echo "üîç Analyzing codebase for skill opportunities..."
          python3 skills/core/librarian-indexer/suggest-skills.py \
            --codebase custom/ \
            --threshold ${{ github.event.inputs.threshold || '500' }} \
            --output .superclaude/shared-context/skill-suggestions.txt \
            --verbose

          # Count suggestions
          SUGGESTION_COUNT=$(wc -l < .superclaude/shared-context/skill-suggestions.txt)
          echo "suggestion_count=$SUGGESTION_COUNT" >> $GITHUB_OUTPUT

          echo "üìã Found $SUGGESTION_COUNT module(s) suitable for skill generation"
          cat .superclaude/shared-context/skill-suggestions.txt

      - name: Generate skills for top modules
        if: github.event.inputs.auto_generate == 'true' || (github.ref == 'refs/heads/main' && steps.suggest.outputs.suggestion_count > 0)
        run: |
          echo "ü§ñ Auto-generating skills for top 5 modules..."

          # Create output directory
          mkdir -p skills/auto-generated/

          # Generate skills for top 5 suggestions
          head -5 .superclaude/shared-context/skill-suggestions.txt | while read module; do
            echo "üìö Generating skill for: $module"
            python3 skills/core/librarian-indexer/auto-generate-skill.py \
              --module "$module" \
              --output "skills/auto-generated/" \
              --verbose || echo "‚ö†Ô∏è  Failed to generate skill for $module"
          done

          echo "‚úÖ Skill generation complete"

      - name: Rebuild skill index
        run: |
          echo "üìá Rebuilding skill index..."
          python3 skills/core/librarian-indexer/index-all-skills.py \
            --skills-dir skills/ \
            --output skills/INDEX.json \
            --generate-readme

          echo "‚úÖ Skill index updated"

          # Show index stats
          if [ -f skills/INDEX.json ]; then
            SKILL_COUNT=$(python3 -c "import json; print(len(json.load(open('skills/INDEX.json'))['skills']))")
            echo "üìä Total skills in index: $SKILL_COUNT"
          fi

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain skills/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù New skills or index changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to skills"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true' && (github.event.inputs.auto_generate == 'true' || github.ref == 'refs/heads/main')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ü§ñ Auto-generate skills from codebase analysis

            Generated by SuperClaude Librarian-Indexer
            - Analyzed modules with complexity >${{ github.event.inputs.threshold || '500' }} LOC
            - Created ${{ steps.suggest.outputs.suggestion_count }} new skill(s)
            - Updated skill index and catalog

            Co-Authored-By: SuperClaude <superclaude@insightpulse.ai>
          branch: auto-skills/${{ github.run_number }}
          delete-branch: true
          title: 'ü§ñ Auto-generate skills from codebase analysis'
          body: |
            ## Summary

            Automatically generated skills based on codebase analysis.

            **Modules Analyzed**: ${{ steps.suggest.outputs.suggestion_count }}
            **Threshold**: ${{ github.event.inputs.threshold || '500' }} lines of code
            **Generated Skills**: See `skills/auto-generated/`

            ## Changes

            - ‚úÖ New skills generated from complex modules
            - ‚úÖ Skill index updated (`skills/INDEX.json`)
            - ‚úÖ README.md catalog regenerated

            ## Review Checklist

            - [ ] Review generated skill documentation
            - [ ] Verify skill metadata (category, expertise level)
            - [ ] Test skill examples work as expected
            - [ ] Ensure integration points are correct

            ## How to Test

            ```bash
            # List new skills
            make skill-list

            # View skill details
            cat skills/auto-generated/<skill-name>/SKILL.md

            # Test skill index
            make skill-index
            ```

            ---

            ü§ñ Generated by SuperClaude Librarian-Indexer
            ‚ö° Powered by [SuperClaude Multi-Agent Framework](https://github.com/jgtolentino/insightpulse-odoo)
          labels: |
            auto-generated
            skills
            superclaude
            enhancement

      - name: Comment on PR with skill suggestions
        if: steps.suggest.outputs.suggestion_count > 0 && steps.changes.outputs.changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const suggestions = fs.readFileSync('.superclaude/shared-context/skill-suggestions.txt', 'utf8');

            const body = `## üí° Skill Generation Suggestions

            The Librarian-Indexer found ${context.payload.inputs?.threshold || '500'}+ LOC modules that could benefit from dedicated skills:

            \`\`\`
            ${suggestions}
            \`\`\`

            **To generate these skills:**

            \`\`\`bash
            # Generate all suggested skills
            make skill-bulk-generate

            # Or generate individually
            make skill-generate MODULE=<module-path>
            \`\`\`

            **To auto-generate in CI:**

            Re-run this workflow with \`auto_generate=true\`

            ---

            ü§ñ SuperClaude Librarian-Indexer`;

            // Find the most recent PR or create an issue
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });

            if (prs.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                body: body
              });
            }

      - name: Upload skill suggestions as artifact
        if: steps.suggest.outputs.suggestion_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: skill-suggestions
          path: .superclaude/shared-context/skill-suggestions.txt
          retention-days: 30
