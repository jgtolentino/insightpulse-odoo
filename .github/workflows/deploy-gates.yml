name: Deploy Gates
on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pyyaml

      - name: Validate Claude config + Section 19
        run: |
          if [ -f scripts/validate-claude-config.py ]; then
            python scripts/validate-claude-config.py
          else
            echo "âš ï¸  validate-claude-config.py not found (skipping)"
          fi
          if [ -f scripts/skillsmith_sync.py ]; then
            chmod +x scripts/skillsmith_sync.py
            ./scripts/skillsmith_sync.py --check || echo "âš ï¸  Section 19 check skipped"
          else
            echo "âš ï¸  skillsmith_sync.py not found (skipping)"
          fi

      - name: DBML â†’ SQL (if schema exists)
        run: |
          if [ -f schema/insightpulse_odoo.dbml ]; then
            npm i -g @dbml/cli
            mkdir -p build
            dbml2sql schema/insightpulse_odoo.dbml --postgres -o build/odoo_schema.sql
            echo "âœ… DBML compiled to SQL"
          else
            echo "âš ï¸  No DBML schema found (skipping)"
          fi

      - name: Fail if TODO markers in generated SQL
        run: |
          if [ -f build/odoo_schema.sql ]; then
            if grep -R "TODO" build/odoo_schema.sql >/dev/null 2>&1; then
              echo "::error ::TODO markers found in generated SQL"
              grep -n "TODO" build/odoo_schema.sql | head -10
              exit 1
            fi
            echo "âœ… No TODO markers in SQL"
          else
            echo "âš ï¸  No generated SQL to check (skipping)"
          fi

      - name: Check T&E MVP structure
        run: |
          echo "âœ… Checking T&E MVP Bundle structure..."
          test -d authhub || echo "âš ï¸  authhub/ not found"
          test -d ocrsvc || echo "âš ï¸  ocrsvc/ not found"
          test -d odoo/modules || echo "âš ï¸  odoo/modules/ not found"
          test -d warehouse || echo "âš ï¸  warehouse/ not found"
          test -d skillsmith || echo "âš ï¸  skillsmith/ not found"
          test -f .github/workflows/tee-mvp-ci.yml || echo "âš ï¸  tee-mvp-ci.yml not found"
          echo "âœ… T&E MVP structure check complete"

      - name: Verify repo variables/secrets (non-blocking)
        run: |
          req_vars=( ODOO_HOST OCR_HOST )
          req_secrets=( SUPABASE_DB_HOST SUPABASE_DB_PORT SUPABASE_DB_NAME SUPABASE_DB_USER SUPABASE_DB_PASSWORD )

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Configuration Verification (T&E MVP Bundle)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "== Repository Variables =="
          for v in "${req_vars[@]}"; do
            if [ -n "${!v:-}" ]; then
              printf "âœ… %s=%s\n" "$v" "${!v}"
            else
              printf "âŒ %s (MISSING - required for deployment)\n" "$v"
            fi
          done

          echo ""
          echo "== Repository Secrets (presence check) =="
          for s in "${req_secrets[@]}"; do
            if [ -n "${!s:-}" ]; then
              printf "âœ… %s present\n" "$s"
            else
              printf "âŒ %s MISSING (required for warehouse/Skillsmith)\n" "$s"
            fi
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â„¹ï¸  Missing config will not block this PR but must be"
          echo "   set before deployment. See PR_DEPLOYMENT_CHECKLIST.md"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
        env:
          ODOO_HOST: ${{ vars.ODOO_HOST }}
          OCR_HOST: ${{ vars.OCR_HOST }}
          SUPABASE_DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          SUPABASE_DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          SUPABASE_DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
