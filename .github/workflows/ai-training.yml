name: AI Training Pipeline

on:
  push:
    branches: ["claude/**"]
    paths:
      - "services/ai-training-hub/**"
      - "services/ai-inference-hub/generate_synthetic_receipts.py"
  workflow_dispatch:
    inputs:
      model_type:
        description: "Model to train"
        required: true
        type: choice
        options:
          - paddleocr
          - smollm
          - whisper
          - all

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linting tools
        run: |
          pip install ruff black mypy

      - name: Run ruff
        run: ruff check services/ai-training-hub/

      - name: Run black
        run: black --check services/ai-training-hub/

      - name: Run mypy
        run: mypy --ignore-missing-imports services/ai-training-hub/

  test-paddleocr-finetuning:
    runs-on: ubuntu-latest
    needs: lint
    if: github.event.inputs.model_type == 'paddleocr' || github.event.inputs.model_type == 'all' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install paddlepaddle paddleocr pillow numpy pyyaml

      - name: Generate synthetic receipts
        run: |
          python services/ai-inference-hub/generate_synthetic_receipts.py

      - name: Test PaddleOCR fine-tuning (dry-run)
        run: |
          python services/ai-training-hub/paddleocr_finetune.py \
            --data /tmp/synthetic_receipts \
            --output ./test_models/paddleocr \
            --epochs 1
        continue-on-error: true  # Training may fail in CI without GPU

      - name: Verify synthetic data generated
        run: |
          test -f /tmp/synthetic_receipts/annotations.json
          test -f /tmp/synthetic_receipts/receipt_0001.png
          echo "âœ“ Synthetic data generated successfully"

  test-smollm-classifier:
    runs-on: ubuntu-latest
    needs: lint
    if: github.event.inputs.model_type == 'smollm' || github.event.inputs.model_type == 'all' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install torch transformers datasets evaluate scikit-learn

      - name: Create sample dataset
        run: |
          python services/ai-training-hub/smollm_classifier.py create-dataset

      - name: Verify dataset created
        run: |
          test -f ./data/github_issues.jsonl
          echo "âœ“ Training dataset created"

      - name: Test SmolLM loading (dry-run)
        run: |
          python -c "from smollm_classifier import SmolLMClassifier; print('âœ“ SmolLM classifier imports successfully')"
        working-directory: services/ai-training-hub

  test-agentic-extraction:
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install paddleocr pillow numpy

      - name: Test agentic extraction (dry-run)
        run: |
          python -c "from agentic_document_extraction import AgenticDocumentExtractor; print('âœ“ Agentic extractor imports successfully')"
        working-directory: services/ai-training-hub

  build-docker-image:
    runs-on: ubuntu-latest
    needs: [test-paddleocr-finetuning, test-smollm-classifier, test-agentic-extraction]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/claude/')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          password: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: services/ai-training-hub
          push: true
          tags: |
            registry.digitalocean.com/insightpulse/ai-training-hub:latest
            registry.digitalocean.com/insightpulse/ai-training-hub:${{ github.sha }}
          cache-from: type=registry,ref=registry.digitalocean.com/insightpulse/ai-training-hub:latest
          cache-to: type=inline

  deploy-mlflow:
    runs-on: ubuntu-latest
    needs: build-docker-image
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to DigitalOcean App Platform
        run: |
          doctl apps create \
            --spec .github/workflows/mlflow-app.yaml \
            --wait

  notify-slack:
    runs-on: ubuntu-latest
    needs: [deploy-mlflow]
    if: always()

    steps:
      - name: Send Slack notification
        run: |
          echo "ðŸš€ AI Training Pipeline: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
