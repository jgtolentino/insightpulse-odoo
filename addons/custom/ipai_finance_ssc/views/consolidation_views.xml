<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Consolidation Tree View -->
    <record id="view_consolidation_tree" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.tree</field>
        <field name="model">finance.ssc.consolidation</field>
        <field name="arch" type="xml">
            <tree string="Consolidations" decoration-info="state == 'draft'" decoration-success="state == 'done'">
                <field name="name"/>
                <field name="period"/>
                <field name="agency_count"/>
                <field name="account_count"/>
                <field name="total_assets" sum="Total Assets" widget="monetary"/>
                <field name="total_liabilities" sum="Total Liabilities" widget="monetary"/>
                <field name="total_equity" sum="Total Equity" widget="monetary"/>
                <field name="net_income" sum="Net Income" widget="monetary"/>
                <field name="state" widget="badge" decoration-info="state == 'draft'" decoration-success="state == 'done'"/>
            </tree>
        </field>
    </record>

    <!-- Consolidation Form View -->
    <record id="view_consolidation_form" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.form</field>
        <field name="model">finance.ssc.consolidation</field>
        <field name="arch" type="xml">
            <form string="Financial Consolidation">
                <header>
                    <button name="action_compute_consolidation"
                            string="Compute Consolidation"
                            type="object"
                            class="btn-primary"
                            attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    <button name="action_export_to_excel"
                            string="Export to Excel"
                            type="object"
                            class="btn-secondary"
                            attrs="{'invisible': [('state', '!=', 'done')]}"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,computing,eliminating,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(action_consolidation_lines)d"
                                type="action"
                                class="oe_stat_button"
                                icon="fa-list"
                                context="{'search_default_consolidation_id': active_id}">
                            <field name="account_count" widget="statinfo" string="Accounts"/>
                        </button>
                        <button name="%(action_consolidation_lines)d"
                                type="action"
                                class="oe_stat_button"
                                icon="fa-building"
                                context="{'search_default_consolidation_id': active_id}">
                            <field name="agency_count" widget="statinfo" string="Agencies"/>
                        </button>
                    </div>

                    <widget name="web_ribbon" title="Consolidated" bg_color="bg-success" attrs="{'invisible': [('state', '!=', 'done')]}"/>

                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group name="basic_info" string="Basic Information">
                            <field name="period" widget="date"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="currency_id"/>
                        </group>
                        <group name="agencies_info" string="Agencies">
                            <field name="agency_ids" widget="many2many_tags" options="{'color_field': 'color', 'no_create': True}"/>
                        </group>
                    </group>

                    <notebook>
                        <page name="financial_summary" string="Financial Summary">
                            <group>
                                <group string="Balance Sheet">
                                    <label for="total_assets" class="fw-bold"/>
                                    <field name="total_assets" widget="monetary" class="fw-bold"/>
                                    <field name="total_liabilities" widget="monetary"/>
                                    <field name="total_equity" widget="monetary"/>
                                </group>
                                <group string="Income Statement">
                                    <field name="total_revenue" widget="monetary"/>
                                    <field name="total_expenses" widget="monetary"/>
                                    <label for="net_income" class="fw-bold"/>
                                    <field name="net_income" widget="monetary" class="fw-bold" decoration-success="net_income &gt; 0" decoration-danger="net_income &lt; 0"/>
                                </group>
                            </group>

                            <!-- Financial Ratios -->
                            <group string="Key Ratios">
                                <group>
                                    <label string="Debt-to-Equity Ratio"/>
                                    <div>
                                        <field name="total_liabilities" invisible="1"/>
                                        <field name="total_equity" invisible="1"/>
                                        <span t-if="record.total_equity.raw_value != 0">
                                            <t t-esc="(record.total_liabilities.raw_value / record.total_equity.raw_value).toFixed(2)"/>
                                        </span>
                                    </div>
                                </group>
                                <group>
                                    <label string="Net Profit Margin %"/>
                                    <div>
                                        <field name="total_revenue" invisible="1"/>
                                        <span t-if="record.total_revenue.raw_value != 0">
                                            <t t-esc="((record.net_income.raw_value / record.total_revenue.raw_value) * 100).toFixed(2)"/>%
                                        </span>
                                    </div>
                                </group>
                            </group>
                        </page>

                        <page name="consolidation_lines" string="Consolidation Lines">
                            <field name="line_ids" nolabel="1">
                                <tree decoration-bf="account_type in ('asset', 'liability', 'equity')" decoration-it="account_type in ('income', 'expense')">
                                    <field name="agency_id"/>
                                    <field name="account_code"/>
                                    <field name="account_name"/>
                                    <field name="account_type" widget="badge"/>
                                    <field name="debit" sum="Total Debit" widget="monetary"/>
                                    <field name="credit" sum="Total Credit" widget="monetary"/>
                                    <field name="balance" sum="Balance" widget="monetary"/>
                                </tree>
                            </field>
                        </page>

                        <page name="eliminations" string="Elimination Entries">
                            <field name="elimination_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="name"/>
                                    <field name="account_debit_id"/>
                                    <field name="account_credit_id"/>
                                    <field name="amount" widget="monetary"/>
                                </tree>
                            </field>
                        </page>

                        <page name="by_agency" string="By Agency">
                            <field name="line_ids" nolabel="1">
                                <pivot string="Consolidation by Agency">
                                    <field name="agency_id" type="row"/>
                                    <field name="account_type" type="col"/>
                                    <field name="balance" type="measure"/>
                                </pivot>
                            </field>
                        </page>

                        <page name="by_account" string="By Account Type">
                            <field name="line_ids" nolabel="1">
                                <graph string="Balances by Account Type" type="bar">
                                    <field name="account_type"/>
                                    <field name="balance" type="measure"/>
                                </graph>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Consolidation Kanban View -->
    <record id="view_consolidation_kanban" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.kanban</field>
        <field name="model">finance.ssc.consolidation</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state">
                <field name="id"/>
                <field name="name"/>
                <field name="period"/>
                <field name="agency_count"/>
                <field name="total_assets"/>
                <field name="net_income"/>
                <field name="state"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                    <div class="o_kanban_record_subtitle">
                                        Period: <field name="period"/> | <field name="agency_count"/> agencies
                                    </div>
                                </div>
                                <span class="float-end">
                                    <field name="state" widget="label" class="badge"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Total Assets: <field name="total_assets" widget="monetary"/></div>
                                <div>Net Income: <field name="net_income" widget="monetary"/></div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Consolidation Search View -->
    <record id="view_consolidation_search" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.search</field>
        <field name="model">finance.ssc.consolidation</field>
        <field name="arch" type="xml">
            <search string="Search Consolidations">
                <field name="name" string="Reference"/>
                <field name="period" string="Period"/>
                <field name="agency_ids" string="Agencies"/>

                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Consolidated" name="done" domain="[('state', '=', 'done')]"/>

                <separator/>
                <filter string="Current Year" name="current_year" domain="[('period', '&gt;=', (context_today().strftime('%Y-01-01'))), ('period', '&lt;=', (context_today().strftime('%Y-12-31')))]"/>
                <filter string="Last Year" name="last_year" domain="[('period', '&gt;=', ((context_today() - relativedelta(years=1)).strftime('%Y-01-01'))), ('period', '&lt;=', ((context_today() - relativedelta(years=1)).strftime('%Y-12-31')))]"/>

                <group expand="0" string="Group By">
                    <filter string="Period" name="group_period" context="{'group_by': 'period:month'}"/>
                    <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Consolidation Line Tree View -->
    <record id="view_consolidation_line_tree" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.line.tree</field>
        <field name="model">finance.ssc.consolidation.line</field>
        <field name="arch" type="xml">
            <tree string="Consolidation Lines" decoration-bf="account_type in ('asset', 'liability', 'equity')" decoration-it="account_type in ('income', 'expense')">
                <field name="consolidation_id"/>
                <field name="agency_id"/>
                <field name="account_code"/>
                <field name="account_name"/>
                <field name="account_type" widget="badge"/>
                <field name="debit" sum="Total Debit" widget="monetary"/>
                <field name="credit" sum="Total Credit" widget="monetary"/>
                <field name="balance" sum="Balance" widget="monetary"/>
            </tree>
        </field>
    </record>

    <!-- Consolidation Line Pivot View -->
    <record id="view_consolidation_line_pivot" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.line.pivot</field>
        <field name="model">finance.ssc.consolidation.line</field>
        <field name="arch" type="xml">
            <pivot string="Consolidation Analysis">
                <field name="agency_id" type="row"/>
                <field name="account_type" type="col"/>
                <field name="balance" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Consolidation Line Graph View -->
    <record id="view_consolidation_line_graph" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.line.graph</field>
        <field name="model">finance.ssc.consolidation.line</field>
        <field name="arch" type="xml">
            <graph string="Consolidation Chart" type="bar">
                <field name="account_type"/>
                <field name="balance" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Consolidation Line Search View -->
    <record id="view_consolidation_line_search" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.line.search</field>
        <field name="model">finance.ssc.consolidation.line</field>
        <field name="arch" type="xml">
            <search string="Search Consolidation Lines">
                <field name="account_code" string="Account Code"/>
                <field name="account_name" string="Account Name"/>
                <field name="agency_id" string="Agency"/>
                <field name="consolidation_id" string="Consolidation"/>

                <filter string="Assets" name="assets" domain="[('account_type', '=', 'asset')]"/>
                <filter string="Liabilities" name="liabilities" domain="[('account_type', '=', 'liability')]"/>
                <filter string="Equity" name="equity" domain="[('account_type', '=', 'equity')]"/>
                <filter string="Income" name="income" domain="[('account_type', '=', 'income')]"/>
                <filter string="Expenses" name="expenses" domain="[('account_type', '=', 'expense')]"/>

                <group expand="0" string="Group By">
                    <filter string="Consolidation" name="group_consolidation" context="{'group_by': 'consolidation_id'}"/>
                    <filter string="Agency" name="group_agency" context="{'group_by': 'agency_id'}"/>
                    <filter string="Account Type" name="group_account_type" context="{'group_by': 'account_type'}"/>
                    <filter string="Account" name="group_account" context="{'group_by': 'account_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Elimination Entry Tree View -->
    <record id="view_consolidation_elimination_tree" model="ir.ui.view">
        <field name="name">finance.ssc.consolidation.elimination.tree</field>
        <field name="model">finance.ssc.consolidation.elimination</field>
        <field name="arch" type="xml">
            <tree string="Elimination Entries" editable="bottom">
                <field name="consolidation_id"/>
                <field name="name"/>
                <field name="account_debit_id"/>
                <field name="account_credit_id"/>
                <field name="amount" sum="Total" widget="monetary"/>
            </tree>
        </field>
    </record>

    <!-- Consolidation Action -->
    <record id="action_consolidation" model="ir.actions.act_window">
        <field name="name">Consolidations</field>
        <field name="res_model">finance.ssc.consolidation</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{'search_default_current_year': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first consolidation
            </p>
            <p>
                Aggregate trial balance across all 8 agencies.
                Generate consolidated financial statements automatically.
            </p>
        </field>
    </record>

    <!-- Consolidation Lines Action -->
    <record id="action_consolidation_lines" model="ir.actions.act_window">
        <field name="name">Consolidation Lines</field>
        <field name="res_model">finance.ssc.consolidation.line</field>
        <field name="view_mode">tree,pivot,graph</field>
        <field name="domain">[('consolidation_id', '=', active_id)]</field>
    </record>

    <!-- Menu Item -->
    <menuitem id="menu_consolidation"
              name="Consolidation"
              parent="menu_finance_ssc_root"
              action="action_consolidation"
              sequence="50"/>

    <!-- Submenu for Analysis -->
    <menuitem id="menu_consolidation_analysis"
              name="Analysis"
              parent="menu_finance_ssc_root"
              sequence="60"/>

    <menuitem id="menu_consolidation_lines_analysis"
              name="Consolidation Lines"
              parent="menu_consolidation_analysis"
              action="action_consolidation_lines"
              sequence="10"/>

</odoo>
