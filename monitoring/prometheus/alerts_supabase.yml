groups:
- name: supabase.alerts
  interval: 30s
  rules:
  - alert: SupabaseDBConnectionsHigh
    expr: |
      sum(pg_stat_activity_count{datname!~"template.*|postgres"}) /
      (select pg_settings.setting::float from pg_settings where name='max_connections') > 0.9
    for: 5m
    labels:
      severity: "critical"
      service: "supabase"
      component: "database"
    annotations:
      summary: "Supabase database connections near max"
      description: "Database connections at {{ $value | humanizePercentage }} of limit"
      runbook: "https://github.com/jgtolentino/insightpulse-odoo/blob/main/docs/runbooks/supabase.md#db-connection-saturation"

  - alert: SupabaseStorageFull
    expr: |
      sum(storage_usage_bytes) by (bucket) /
      sum(storage_quota_bytes) by (bucket) > 0.95
    for: 10m
    labels:
      severity: "critical"
      service: "supabase"
      component: "storage"
    annotations:
      summary: "Supabase storage quota >95%"
      description: "Storage bucket {{ $labels.bucket }} is {{ $value | humanizePercentage }} full"
      runbook: "https://github.com/jgtolentino/insightpulse-odoo/blob/main/docs/runbooks/supabase.md#storage-full"

  - alert: SupabaseRLSPolicyViolation
    expr: increase(supabase_rls_violations_total[1h]) > 10
    for: 5m
    labels:
      severity: "warning"
      service: "supabase"
      component: "security"
    annotations:
      summary: "Supabase RLS policy violations detected"
      description: "{{ $value }} RLS violations in the last hour"
      runbook: "https://github.com/jgtolentino/insightpulse-odoo/blob/main/docs/runbooks/supabase.md#rls-policy-leak"

  - alert: SupabaseEdgeFunctionTimeout
    expr: |
      histogram_quantile(0.95,
        sum(rate(edge_function_duration_seconds_bucket[5m])) by (function, le)
      ) > 55
    for: 10m
    labels:
      severity: "warning"
      service: "supabase"
      component: "edge-functions"
    annotations:
      summary: "Supabase Edge Function {{ $labels.function }} p95 duration >55s"
      description: "Edge function {{ $labels.function }} p95 duration is {{ $value }}s (timeout at 60s)"
      runbook: "https://github.com/jgtolentino/insightpulse-odoo/blob/main/docs/runbooks/supabase.md#edge-function-timeout"

  - alert: SupabaseEdgeFunctionErrors
    expr: |
      sum(rate(edge_function_errors_total[5m])) by (function) /
      sum(rate(edge_function_invocations_total[5m])) by (function) > 0.1
    for: 5m
    labels:
      severity: "warning"
      service: "supabase"
      component: "edge-functions"
    annotations:
      summary: "Supabase Edge Function {{ $labels.function }} error rate >10%"
      description: "Edge function {{ $labels.function }} error rate is {{ $value | humanizePercentage }}"

  - alert: SupabaseDatabaseDiskFull
    expr: |
      pg_database_size_bytes /
      (select pg_settings.setting::float from pg_settings where name='data_directory_size') > 0.9
    for: 10m
    labels:
      severity: "critical"
      service: "supabase"
      component: "database"
    annotations:
      summary: "Supabase database disk >90% full"
      description: "Database disk usage is {{ $value | humanizePercentage }}"

  - alert: SupabaseAuthRateLimit
    expr: rate(supabase_auth_rate_limit_hits_total[5m]) > 10
    for: 5m
    labels:
      severity: "warning"
      service: "supabase"
      component: "auth"
    annotations:
      summary: "Supabase Auth rate limit being hit"
      description: "Auth rate limit hit {{ $value }} times/sec"

  - alert: SupabasePostgRESTDown
    expr: up{job="postgrest"} == 0
    for: 2m
    labels:
      severity: "critical"
      service: "supabase"
      component: "postgrest"
    annotations:
      summary: "Supabase PostgREST is down"
      description: "PostgREST has been down for more than 2 minutes"
