
services:
  # Main services orchestration
  # For detailed service configurations, see infrastructure/docker/

  odoo:
    # Image set via env var with pinned digest. Use scripts/pin_images.sh to generate .env file.
    image: ${ODOO_IMAGE:-odoo:19.0}
    depends_on:
      - postgres
    ports:
      - "8069:8069"
      - "8072:8072"  # Longpolling port for real-time features
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - HTTP_PORT=8069
      - LONGPOLLING_PORT=8072
    volumes:
      # Custom InsightPulse modules (new structure)
      - ./addons:/mnt/addons:ro

      # OCA modules (git submodules - to be populated)
      - ./addons/oca:/mnt/oca:ro

      # Configuration
      - ./odoo.conf:/etc/odoo/odoo.conf:ro

      # Persistent data
      - odoo_data:/var/lib/odoo

  postgres:
    image: ${PG_IMAGE:-postgres:16-alpine}
    environment:
      - POSTGRES_DB=odoo
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=odoo
    volumes:
      - postgres_data:/var/lib/postgresql/data

  caddy:
    image: ${CADDY_IMAGE:-caddy:2-alpine}
    restart: unless-stopped
    environment:
      - ACME_AGREE=true
      - EMAIL=admin@insightpulseai.com
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - odoo

volumes:
  postgres_data:
  odoo_data:
  caddy_data:
  caddy_config:
