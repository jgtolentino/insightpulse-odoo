FROM odoo:19.0

USER root

# Copy custom addons
COPY addons/ipai_agent_hybrid /mnt/extra-addons/ipai_agent_hybrid
# Note: ipai_ocr will be added in Phase 3 after module creation

# Install Python dependencies for modules and curl for healthcheck
RUN pip3 install --no-cache-dir \
    supabase \
    openai \
    requests \
    && apt-get update \
    && apt-get install -y --no-install-recommends curl \
    && rm -rf /var/lib/apt/lists/*

# Create odoo configuration directory
RUN mkdir -p /etc/odoo

# Expose Odoo port
EXPOSE 8069

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
  CMD curl -f http://localhost:8069/web/health || exit 1

# Set proper permissions
RUN chown -R odoo:odoo /mnt/extra-addons

USER odoo

# Entry point and command (use shell form to expand env vars)
ENTRYPOINT ["/entrypoint.sh"]
CMD odoo --db_host=$DB_HOST --db_port=$DB_PORT --db_user=$DB_USER --db_password=$DB_PASSWORD --addons-path=/mnt/extra-addons,/usr/lib/python3/dist-packages/odoo/addons
