# Odoo upstream
upstream odoo {
    server 127.0.0.1:8069;
}

# HTTP to HTTPS redirect
server {
  listen 80;
  server_name erp.insightpulseai.net;
  return 301 https://$host$request_uri;
}

# Main HTTPS server with security hardening
server {
  listen 443 ssl http2;
  server_name erp.insightpulseai.net;

  ssl_certificate /etc/letsencrypt/live/erp.insightpulseai.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/erp.insightpulseai.net/privkey.pem;

  # Security headers - CSP to allow Superset integration
  add_header Content-Security-Policy "default-src 'self' https://erp.insightpulseai.net https://superset.insightpulseai.net; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://superset.insightpulseai.net; font-src 'self' data:; connect-src 'self' https://superset.insightpulseai.net; frame-src 'self' https://superset.insightpulseai.net; frame-ancestors 'self';" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # Enable sub_filter to rewrite odoo.com URLs in responses
  sub_filter_types text/html text/css text/javascript application/javascript;
  sub_filter 'https://www.odoo.com/app/' 'https://erp.insightpulseai.net/web#menu_id=';
  sub_filter 'http://www.odoo.com/app/' 'https://erp.insightpulseai.net/web#menu_id=';
  sub_filter '//www.odoo.com/app/' 'https://erp.insightpulseai.net/web#menu_id=';
  sub_filter_once off;

  proxy_read_timeout 600s;
  proxy_connect_timeout 60s;

  # Redirect login page to landing page (unified SSO)
  location ~ ^/web/login {
    return 301 https://insightpulseai.net/;
  }

  # Block known upsell/upgrade paths (returns 403 Forbidden)
  location ~ ^/(web/enterprise/upgrade|web/upsell|iap/.*) {
    return 403;
  }

  # Block odoo.com app redirects (redirect to local Odoo)
  location ~* ^/(app/.*|apps/.*) {
    return 301 https://erp.insightpulseai.net/web#menu_id=;
  }

  # Redirect Odoo dashboards to Superset
  location /odoo/dashboards {
    # Check if dashboard_id parameter exists
    if ($args ~ "dashboard_id=([0-9]+)") {
      set $dashboard_id $1;
      return 301 https://superset.insightpulseai.net/superset/dashboard/$dashboard_id/;
    }
    # Default: redirect to dashboard list
    return 301 https://superset.insightpulseai.net/superset/dashboard/list/;
  }

  # Redirect /dashboards to Superset (short URL)
  location /dashboards {
    if ($args ~ "dashboard_id=([0-9]+)") {
      set $dashboard_id $1;
      return 301 https://superset.insightpulseai.net/superset/dashboard/$dashboard_id/;
    }
    return 301 https://superset.insightpulseai.net/superset/dashboard/list/;
  }

  # Main proxy location
  location / {
    proxy_pass http://odoo;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }
}
