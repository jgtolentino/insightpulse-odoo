# Nginx configuration for agent.insightpulseai.net
# Location: /etc/nginx/sites-available/agent.insightpulseai.net
# Enable with: ln -s /etc/nginx/sites-available/agent.insightpulseai.net /etc/nginx/sites-enabled/

# Reverse proxy to DigitalOcean Agents Platform
# Upstream: https://wr2azp5dsl6mu6xvxtpglk5v.agents.do-ai.run

server {
  listen 80;
  server_name agent.insightpulseai.net;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name agent.insightpulseai.net;

  # SSL certificates (managed by certbot)
  ssl_certificate /etc/letsencrypt/live/agent.insightpulseai.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/agent.insightpulseai.net/privkey.pem;

  # SSL configuration
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  # DNS resolver for upstream hostname resolution
  resolver 1.1.1.1 8.8.8.8 valid=300s;
  resolver_timeout 5s;

  # Reverse proxy to DO Agents
  location / {
    proxy_http_version 1.1;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;  # DO Agents has valid cert, but we trust it

    # Proxy to DO Agents upstream
    proxy_pass https://wr2azp5dsl6mu6xvxtpglk5v.agents.do-ai.run;

    # CRITICAL: Upstream expects its own Host header
    proxy_set_header Host wr2azp5dsl6mu6xvxtpglk5v.agents.do-ai.run;

    # Forward original client info
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;

    # WebSocket support (if agent uses it)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Extended timeouts for AI agent responses
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_connect_timeout 60s;

    # Buffering
    proxy_buffering off;
    proxy_request_buffering off;
  }

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;

  # CORS headers (if needed for web client access)
  add_header Access-Control-Allow-Origin "https://erp.insightpulseai.net" always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
  add_header Access-Control-Allow-Credentials "true" always;

  # Logging
  access_log /var/log/nginx/agent.insightpulseai.net.access.log;
  error_log /var/log/nginx/agent.insightpulseai.net.error.log;
}
