name: knowledge_lookup
version: 0.1.0
description: >
  Unified tool wrapper to query the knowledge graph, append observations,
  and trigger harvesting/learning passes. Provides agents with access to
  the exponentially-growing skills library, Odoo knowledge base, and error
  resolution patterns.

category: knowledge
tags:
  - knowledge
  - search
  - learning
  - skills
  - errors
  - automation
  - rl-training

entrypoints:
  - name: search
    description: >
      Retrieve prior skills, traces, or solutions relevant to the current task.
      Uses semantic search with embeddings for relevance matching.
    inputs:
      - name: query
        type: string
        required: true
        description: Natural language description of intent, stack, or error.
        examples:
          - "create odoo sales order with partner validation"
          - "migrate custom module from v18 to v19"
          - "fix ValidationError: Partner not found"

      - name: query_type
        type: string
        required: false
        default: "auto"
        enum: ["skills", "knowledge", "errors", "auto"]
        description: Type of knowledge to search. "auto" infers from query.

      - name: category
        type: string
        required: false
        enum: ["odoo", "git", "automation", "conflict", "general"]
        description: Optional category filter for skills.

      - name: odoo_version
        type: string
        required: false
        description: Optional Odoo version filter for knowledge docs.
        examples: ["19.0", "18.0", "17.0"]

      - name: threshold
        type: number
        required: false
        default: 0.7
        minimum: 0.0
        maximum: 1.0
        description: Minimum similarity score (0-1) for results.

      - name: limit
        type: integer
        required: false
        default: 20
        minimum: 1
        maximum: 100
        description: Maximum number of results to return.

    outputs:
      - name: results
        type: array
        description: List of matching knowledge items with similarity scores.
      - name: total_found
        type: integer
        description: Total number of matches found.

  - name: record_outcome
    description: >
      Persist a run outcome into the knowledge graph (success / partial / error).
      Feeds the RL training dataset and skill harvesting pipeline.
    inputs:
      - name: run_id
        type: string
        required: true
        description: Unique identifier for this agent run (trace ID).

      - name: agent_name
        type: string
        required: true
        description: Name of the agent that executed this run.

      - name: outcome
        type: string
        required: true
        enum: ["success", "partial", "error"]
        description: Overall outcome of the run.

      - name: confidence_score
        type: number
        required: false
        minimum: 0.0
        maximum: 1.0
        description: Confidence score for this run (from TRM adapter).

      - name: input_data
        type: object
        required: false
        description: Input parameters provided to the agent.

      - name: plan
        type: object
        required: false
        description: Execution plan generated by the agent.

      - name: output_data
        type: object
        required: false
        description: Output produced by the agent.

      - name: metadata
        type: object
        required: false
        description: Additional context (tools used, duration, etc.).

      - name: human_approved
        type: boolean
        required: false
        default: false
        description: Whether a human reviewed and approved this run.

    outputs:
      - name: status
        type: string
        description: "recorded" or "failed"
      - name: record_id
        type: string
        description: Database ID of the recorded observation.

  - name: harvest_skills
    description: >
      Run a skill harvest pass over recent runs to derive new reusable skills.
      Triggers auto-generation pipeline with GPT-4.
    inputs:
      - name: max_runs
        type: integer
        required: false
        default: 100
        description: Maximum number of recent runs to analyze.

      - name: hours
        type: integer
        required: false
        default: 24
        description: Look back this many hours for successful runs.

      - name: min_confidence
        type: number
        required: false
        default: 0.75
        description: Minimum confidence score to harvest.

      - name: force
        type: boolean
        required: false
        default: false
        description: Overwrite existing skills with same name.

    outputs:
      - name: harvested_count
        type: integer
        description: Number of new skills harvested.
      - name: skill_names
        type: array
        description: Names of harvested skills.
      - name: skipped_count
        type: integer
        description: Number of candidate patterns skipped.

  - name: learn_from_errors
    description: >
      Run the error learner over recent failed runs to capture patterns and fixes.
      Auto-generates guardrail skills to prevent recurring errors.
    inputs:
      - name: lookback_days
        type: integer
        required: false
        default: 7
        description: How many days to look back for errors.

      - name: min_occurrences
        type: integer
        required: false
        default: 2
        description: Minimum error occurrences to trigger learning.

    outputs:
      - name: patterns_learned
        type: integer
        description: Number of error patterns identified.
      - name: guardrails_created
        type: integer
        description: Number of guardrail skills created.
      - name: error_signatures
        type: array
        description: List of error signature hashes.

  - name: check_error
    description: >
      Check if an error is already known and has a resolution. Returns
      guardrail skill if available.
    inputs:
      - name: error_message
        type: string
        required: true
        description: The error message to check.

      - name: error_type
        type: string
        required: false
        description: Error type/exception class.

    outputs:
      - name: is_known
        type: boolean
        description: Whether this error pattern is known.
      - name: similarity
        type: number
        description: Similarity score to closest known error.
      - name: resolution_skill
        type: string
        description: Name of skill that prevents this error.
      - name: prevention_notes
        type: string
        description: Human-readable prevention strategy.
      - name: occurrences
        type: integer
        description: How many times this error has occurred.

routing:
  implementation:
    type: agent
    agent: knowledge_client
    tool_map:
      search: knowledge_query
      record_outcome: knowledge_append_observation
      harvest_skills: knowledge_harvest_skills
      learn_from_errors: knowledge_learn_errors
      check_error: knowledge_check_error

observability:
  traces:
    enabled: true
    provider: opentelemetry
  metrics:
    enabled: true
    custom_metrics:
      - knowledge_search_requests_total
      - knowledge_harvest_triggered_total
      - knowledge_errors_checked_total

dependencies:
  - knowledge_client

examples:
  - name: search_for_odoo_skill
    description: Find existing skills for Odoo sales order creation
    input:
      entrypoint: search
      args:
        query: "create odoo sales order with partner validation"
        query_type: "skills"
        category: "odoo"
        limit: 5
    expected_output:
      results:
        - type: "skill"
          title: "Create Sales Order with Validation"
          similarity: 0.92

  - name: record_successful_run
    description: Record a successful agent execution
    input:
      entrypoint: record_outcome
      args:
        run_id: "trace-abc123"
        agent_name: "automation_executor"
        outcome: "success"
        confidence_score: 0.89
        metadata:
          tools_used: ["create_sales_order"]
          duration_ms: 1250
    expected_output:
      status: "recorded"
      record_id: "uuid-123"

  - name: trigger_skill_harvest
    description: Harvest skills from last 24 hours
    input:
      entrypoint: harvest_skills
      args:
        hours: 24
        min_confidence: 0.75
    expected_output:
      harvested_count: 3
      skill_names: ["skill_a", "skill_b", "skill_c"]

progressive_disclosure:
  trigger_conditions:
    - agent needs to search for existing solutions
    - agent completed a task (success or failure)
    - daily automation cron runs
    - error rate above threshold
  load_priority: high
  unload_conditions:
    - agent session ends
    - no knowledge operations for 10 minutes
