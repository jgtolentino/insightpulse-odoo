name: knowledge_client
version: 0.1.0
description: >
  Agent wrapper around the knowledge-first automation infrastructure. Provides
  read/write access to the Supabase-backed knowledge graph, plus on-demand
  harvesting and error learning.

  This agent serves as the canonical interface to:
  - Skills library (auto-growing capability database)
  - Odoo knowledge base (100K+ docs from community)
  - Error patterns (known failures and resolutions)
  - Agent execution history (for RL training)

runtime:
  type: python
  entrypoint: scripts/knowledge/knowledge_client.py
  env:
    SUPABASE_URL: "${SUPABASE_URL}"
    SUPABASE_SERVICE_ROLE_KEY: "${SUPABASE_SERVICE_ROLE_KEY}"
    SUPABASE_KNOWLEDGE_SCHEMA: "${SUPABASE_KNOWLEDGE_SCHEMA:-public}"
    KNOWLEDGE_CLIENT_TIMEOUT_SEC: "${KNOWLEDGE_CLIENT_TIMEOUT_SEC:-10}"
    KNOWLEDGE_CLIENT_LOG_LEVEL: "${KNOWLEDGE_CLIENT_LOG_LEVEL:-INFO}"
    OPENAI_API_KEY: "${OPENAI_API_KEY}"
    OPENAI_EMBEDDING_MODEL: "${OPENAI_EMBEDDING_MODEL:-text-embedding-3-large}"
    OPENAI_EMBEDDING_DIMS: "${OPENAI_EMBEDDING_DIMS:-3072}"

scopes:
  - knowledge.read
  - knowledge.write
  - knowledge.harvest
  - knowledge.learn

interfaces:
  - type: tool
    tools:
      - name: knowledge_query
        description: >
          Query the knowledge graph for existing skills, patterns, or prior runs
          matching the current intent or error signature. Uses semantic search
          with embeddings for relevance matching.
        input_schema:
          type: object
          properties:
            query:
              type: string
              description: Natural-language or structured query describing the desired knowledge.
              examples:
                - "create odoo sales order with validation"
                - "migrate custom module from v18 to v19"
                - "fix ValidationError: Partner not found"
            query_type:
              type: string
              enum: ["skills", "knowledge", "errors", "auto"]
              default: "auto"
              description: Type of knowledge to search. "auto" infers from query.
            category:
              type: string
              enum: ["odoo", "git", "automation", "conflict", "general"]
              description: Optional category filter for skills.
            odoo_version:
              type: string
              description: Optional Odoo version filter for knowledge docs.
              examples: ["19.0", "18.0", "17.0"]
            threshold:
              type: number
              minimum: 0.0
              maximum: 1.0
              default: 0.7
              description: Minimum similarity score (0-1) for results.
            limit:
              type: integer
              minimum: 1
              maximum: 100
              default: 20
              description: Maximum number of results to return.
          required: ["query"]
        output_schema:
          type: object
          properties:
            results:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  type:
                    type: string
                    enum: ["skill", "knowledge", "error"]
                  title:
                    type: string
                  content:
                    type: string
                  similarity:
                    type: number
                  metadata:
                    type: object
            query_type:
              type: string
            total_found:
              type: integer

      - name: knowledge_append_observation
        description: >
          Append a new observation (success, partial, or error) tied to a run,
          including prompt, tools used, and outcome. This feeds the RL training
          dataset and skill harvesting pipeline.
        input_schema:
          type: object
          properties:
            run_id:
              type: string
              description: Unique identifier for this agent run (trace ID).
            agent_name:
              type: string
              description: Name of the agent that executed this run.
            outcome:
              type: string
              enum: ["success", "partial", "error"]
              description: Overall outcome of the run.
            confidence_score:
              type: number
              minimum: 0.0
              maximum: 1.0
              description: Confidence score for this run (from TRM adapter).
            input_data:
              type: object
              description: Input parameters provided to the agent.
            plan:
              type: object
              description: Execution plan generated by the agent.
            output_data:
              type: object
              description: Output produced by the agent.
            metadata:
              type: object
              description: Additional context (tools used, duration, etc.).
            human_approved:
              type: boolean
              default: false
              description: Whether a human reviewed and approved this run.
          required: ["run_id", "agent_name", "outcome"]
        output_schema:
          type: object
          properties:
            status:
              type: string
              enum: ["recorded", "failed"]
            record_id:
              type: string

      - name: knowledge_harvest_skills
        description: >
          Invoke the skill harvester to mine new reusable skills from recent
          successful runs and store them as first-class skill records. This
          triggers the auto-generation pipeline.
        input_schema:
          type: object
          properties:
            max_runs:
              type: integer
              default: 100
              description: Maximum number of recent runs to analyze.
            hours:
              type: integer
              default: 24
              description: Look back this many hours for successful runs.
            min_confidence:
              type: number
              default: 0.75
              description: Minimum confidence score to harvest.
            force:
              type: boolean
              default: false
              description: Overwrite existing skills with same name.
        output_schema:
          type: object
          properties:
            harvested_count:
              type: integer
            skill_names:
              type: array
              items:
                type: string
            skipped_count:
              type: integer

      - name: knowledge_learn_errors
        description: >
          Invoke the error learner to mine error patterns and candidate fixes
          from recent failed runs. Auto-generates guardrail skills to prevent
          recurring errors.
        input_schema:
          type: object
          properties:
            lookback_days:
              type: integer
              default: 7
              description: How many days to look back for errors.
            min_occurrences:
              type: integer
              default: 2
              description: Minimum error occurrences to trigger learning.
          required: []
        output_schema:
          type: object
          properties:
            patterns_learned:
              type: integer
            guardrails_created:
              type: integer
            error_signatures:
              type: array
              items:
                type: string

      - name: knowledge_check_error
        description: >
          Check if an error is already known and has a resolution. Returns
          guardrail skill if available.
        input_schema:
          type: object
          properties:
            error_message:
              type: string
              description: The error message to check.
            error_type:
              type: string
              description: Error type/exception class.
          required: ["error_message"]
        output_schema:
          type: object
          properties:
            is_known:
              type: boolean
            similarity:
              type: number
            resolution_skill:
              type: string
              description: Name of skill that prevents this error.
            prevention_notes:
              type: string
            occurrences:
              type: integer

observability:
  traces:
    enabled: true
    provider: opentelemetry
    attributes:
      service.name: "insightpulse-knowledge-client"
      service.component: "knowledge_graph"
      service.version: "0.1.0"
  metrics:
    enabled: true
    metrics:
      - name: knowledge_query_duration_seconds
        type: histogram
        description: Time to execute knowledge queries
      - name: knowledge_query_results_total
        type: counter
        description: Total results returned from queries
      - name: knowledge_harvest_skills_total
        type: counter
        description: Total skills harvested
      - name: knowledge_errors_learned_total
        type: counter
        description: Total error patterns learned

policy:
  rate_limit:
    enabled: ${KNOWLEDGE_CLIENT_RATE_LIMIT_ENABLED:-true}
    requests_per_minute: ${KNOWLEDGE_CLIENT_RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
  timeout_sec: ${KNOWLEDGE_CLIENT_TIMEOUT_SEC:-10}
  max_query_results: ${KNOWLEDGE_MAX_QUERY_RESULTS:-100}

dependencies:
  - supabase-py>=2.0.0
  - openai>=1.0.0
  - httpx>=0.25.0
  - beautifulsoup4>=4.12.0
